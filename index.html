<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGrid Pro - Battery & Sun Update</title>
    <style>
        :root { --wind-speed: 2s; --cloud-opacity: 0.2; --sun-pos: 10%; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Courier New', monospace; background: #4caf50; }

        #game-viewport {
            width: 100vw; height: 100vh;
            background-color: #4caf50;
            background-image: radial-gradient(#55ad58 15%, transparent 16%);
            background-size: 30px 30px;
            position: relative; transition: background 3s;
        }
        .night-mode #game-viewport { background-color: #0b1a0b; filter: brightness(0.6); }

        /* SOLE */
        #sun {
            position: absolute; top: var(--sun-pos); left: 50%; transform: translateX(-50%);
            width: 80px; height: 80px; background: radial-gradient(#fff700, #ff9100);
            border-radius: 50%; box-shadow: 0 0 50px gold; z-index: 2; transition: top 2s;
        }
        .night-mode #sun { top: 110%; }

        /* DASHBOARD BASSO DESTRA */
        .dashboard {
            position: fixed; bottom: 100px; right: 20px;
            background: rgba(0, 10, 0, 0.9); color: #00ff41;
            padding: 15px; border-radius: 10px; width: 240px;
            z-index: 1000; border: 1px solid #00ff41;
        }
        .data-row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 12px; }

        /* BATTERIA UI */
        #battery-ui { border-top: 1px solid #333; margin-top: 10px; padding-top: 10px; }
        .batt-bar-bg { width: 100%; height: 10px; background: #222; border-radius: 5px; overflow: hidden; }
        #batt-level { height: 100%; background: #00ff41; width: 50%; transition: width 0.3s; }

        /* ASSET */
        .asset { position: absolute; z-index: 10; overflow: visible; }
        .blades { transform-origin: 32px 20px; animation: spin var(--wind-speed) linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* FUMO */
        .smoke { fill: #fff; opacity: 0; }
        .active-thermal .smoke { animation: puff 2s infinite linear; }
        @keyframes puff { 0% { transform: translateY(0); opacity: 0.5; } 100% { transform: translateY(-40px) scale(2); opacity: 0; } }

        /* CONTROLLI BASSO */
        .ui-bottom {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #fff; padding: 15px 30px; border-radius: 50px;
            display: flex; gap: 20px; align-items: center; z-index: 100; box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }
        .btn-toggle { padding: 5px 15px; cursor: pointer; background: #eee; border: 1px solid #ccc; border-radius: 5px; font-size: 12px; }
        .btn-active { background: #00ff41; border-color: #008000; }
    </style>
</head>
<body>

<div id="game-viewport">
    <div id="sun"></div>

    <svg class="asset" style="top:25%; right:0; width:30%; height:40px;"><rect fill="#4fc3f7" width="100%" height="20" rx="10"/></svg>
    
    <svg class="asset" style="top:15%; left:12%; width:60px;" viewBox="0 0 64 64"><path fill="#ddd" d="M30 62 L34 62 L32 20 Z" /><g class="blades"><path fill="#fff" d="M32 20 L32 2 L35 2 Z M32 20 L48 30 L46 32 Z M32 20 L16 30 L18 32 Z" /></g></svg>
    <svg id="thermal-plant" class="asset" style="top:18%; left:80%; width:100px" viewBox="0 0 64 64"><circle class="smoke" cx="20" cy="15" r="5"/><rect fill="#333" x="10" y="40" width="40" height="20"/><rect fill="#555" x="16" y="20" width="8" height="20"/></svg>

    <svg class="asset" style="top:45%; left:45%; width:50px" viewBox="0 0 64 64"><rect fill="#e57373" x="10" y="30" width="30" height="30"/></svg>

    <svg class="asset" style="top:70%; left:45%; width:40px" viewBox="0 0 64 64">
        <rect fill="#333" x="10" y="10" width="44" height="44" rx="5"/>
        <rect fill="#00ff41" id="phys-batt-level" x="15" y="45" width="34" height="5"/>
    </svg>

    <svg class="asset" style="top:70%; left:75%; width:80px" viewBox="0 0 64 64"><rect fill="#1a237e" x="5" y="30" width="50" height="20" rx="2"/></svg>
    <svg class="asset" style="top:80%; left:75%; width:80px" viewBox="0 0 64 64"><rect fill="#1a237e" x="5" y="30" width="50" height="20" rx="2"/></svg>
    <svg class="asset" style="top:70%; left:85%; width:80px" viewBox="0 0 64 64"><rect fill="#1a237e" x="5" y="30" width="50" height="20" rx="2"/></svg>
    <svg class="asset" style="top:80%; left:85%; width:80px" viewBox="0 0 64 64"><rect fill="#1a237e" x="5" y="30" width="50" height="20" rx="2"/></svg>
</div>

<div class="dashboard">
    <div class="data-row">EOLICO: <span id="db-wind">0</span> MW</div>
    <div class="data-row">SOLARE: <span id="db-solar">0</span> MW</div>
    <div class="data-row">TERMICO: <span id="db-thermal">0</span> MW</div>
    <div class="data-row">DOMANDA: <span id="db-demand">0</span> MW</div>
    <div id="battery-ui">
        <div class="data-row">ACCUMULO: <span id="db-batt-perc">50%</span></div>
        <div class="batt-bar-bg"><div id="batt-level"></div></div>
        <div class="data-row" style="font-size:10px; margin-top:5px;">STATO: <span id="db-batt-mode">IDLE</span></div>
    </div>
</div>

<div class="ui-bottom">
    <div>ðŸ•’ <span id="clock">12:00</span></div>
    <div>ðŸ”¥ Centrale: <input type="range" id="thermal-slider" value="0"></div>
    <button id="toggle-batt" class="btn-toggle">USO BATTERIA: OFF</button>
</div>

<script>
    let time = 12;
    let wind = 30;
    let batteryCharge = 50; 
    let useBattery = false;

    document.getElementById('toggle-batt').onclick = function() {
        useBattery = !useBattery;
        this.innerText = "USO BATTERIA: " + (useBattery ? "ON" : "OFF");
        this.classList.toggle('btn-active');
    };

    function gameLoop() {
        time = (time + 0.01) % 24;
        document.getElementById('clock').innerText = Math.floor(time).toString().padStart(2, '0') + ":00";
        const isNight = time > 19 || time < 6;
        document.body.classList.toggle('night-mode', isNight);
        document.documentElement.style.setProperty('--sun-pos', isNight ? '110%' : '10%');

        // Vento e Nuvole
        wind += (Math.random() - 0.5) * 1.2;
        wind = Math.max(5, Math.min(80, wind));
        document.documentElement.style.setProperty('--wind-speed', (100 - wind) / 20 + 's');
        let cloudFactor = 0.2 + Math.abs(Math.sin(time/4)) * 0.6;
        let solarProd = isNight ? 0 : Math.floor(120 * (1 - cloudFactor));

        // Centrale
        const thermalProd = parseInt(document.getElementById('thermal-slider').value);
        document.getElementById('thermal-plant').classList.toggle('active-thermal', thermalProd > 5);

        // Calcolo Rete
        const demand = isNight ? 40 : 120;
        let netProduction = Math.floor(wind + solarProd + thermalProd);
        let balance = netProduction - demand;

        // Logica Batteria
        let battMode = "IDLE";
        if (balance > 0) {
            batteryCharge = Math.min(100, batteryCharge + 0.05);
            battMode = "IN CARICA";
        } else if (balance < 0 && useBattery && batteryCharge > 0) {
            let drain = Math.min(batteryCharge, Math.abs(balance) / 10);
            batteryCharge -= drain;
            netProduction += drain * 10;
            balance = netProduction - demand;
            battMode = "SCARICA";
        }

        // Aggiornamento UI
        document.getElementById('db-wind').innerText = Math.floor(wind);
        document.getElementById('db-solar').innerText = solarProd;
        document.getElementById('db-thermal').innerText = thermalProd;
        document.getElementById('db-demand').innerText = demand;
        document.getElementById('db-batt-perc').innerText = Math.floor(batteryCharge) + "%";
        document.getElementById('batt-level').style.width = batteryCharge + "%";
        document.getElementById('phys-batt-level').style.height = (batteryCharge/2.5) + "px";
        document.getElementById('db-batt-mode').innerText = battMode;

        requestAnimationFrame(gameLoop);
    }
    gameLoop();
</script>
</body>
</html>
