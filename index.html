<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGrid - Advanced Urban Map</title>
    <style>
        :root { --wind-speed: 2s; --window-light: transparent; --lamp-glow: 0; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #2d3436; }

        #game-viewport {
            width: 100vw; height: 100vh;
            background: #55ad58;
            position: relative; transition: filter 2s, background 2s;
        }

        .night-mode #game-viewport { background: #1a2a1a; filter: brightness(0.7); }
        .night-mode { --window-light: #fff176; --lamp-glow: 1; }

        /* MONTAGNA */
        .mountain {
            position: absolute; top: 5%; left: 5%; width: 250px; height: 150px;
            background: #7f8c8d; clip-path: polygon(0% 100%, 50% 0%, 100% 100%);
            z-index: 2; border-bottom: 20px solid #636e72;
        }

        /* STRADE E AUTO */
        .road { position: absolute; background: #444; z-index: 1; border: 2px solid #333; }
        .road-v { width: 50px; height: 100%; left: 45%; }
        .road-h { width: 100%; height: 50px; top: 60%; }
        
        .car {
            position: absolute; width: 20px; height: 12px; background: #e74c3c;
            border-radius: 3px; z-index: 5; transition: left 1s linear;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }

        /* LAMPIONI */
        .street-light {
            position: absolute; width: 4px; height: 30px; background: #2d3436; z-index: 6;
        }
        .light-bulb {
            position: absolute; top: -5px; left: -3px; width: 10px; height: 10px;
            background: #fff176; border-radius: 50%; opacity: var(--lamp-glow);
            box-shadow: 0 0 20px #fff176; transition: 1s;
        }

        /* ASSET */
        .asset { position: absolute; z-index: 10; }
        .house { width: 40px; height: 50px; transform: scale(0.9); }
        .front { width: 30px; height: 30px; background: #ecf0f1; top: 15px; left: 0; }
        .side { width: 20px; height: 30px; background: #bdc3c7; top: 8px; left: 30px; transform: skewY(-20deg); }
        .roof { width: 30px; height: 20px; background: #c0392b; top: 0; left: 10px; transform: skewX(-45deg); }
        .win { width: 5px; height: 6px; background: var(--window-light); position: absolute; transition: 1s; }

        /* PANNELLI 3D & RECINTO */
        .solar-block { width: 60px; height: 40px; background: #1a237e; transform: rotateX(45deg) skewX(-10deg); border: 1px solid #3f51b5; }
        .fence { border: 2px dashed #2c3e50; padding: 10px; background: rgba(0,0,0,0.05); }

        /* DASHBOARD TRASCINABILE */
        #dashboard {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.9); color: #00ff41; padding: 15px;
            border-radius: 10px; width: 220px; border: 1px solid #00ff41;
            z-index: 1000; cursor: move; font-family: monospace;
        }
    </style>
</head>
<body>

<div id="game-viewport">
    <div class="mountain"></div>
    
    <div class="road road-v"></div>
    <div class="road road-h"></div>
    <div id="cars-container"></div>
    <div id="lights-container"></div>

    <div id="wind-farm" style="z-index:11"></div>
    <div id="residential" style="z-index:11"></div>
    
    <div class="asset fence" style="bottom:10%; right:10%;">
        <div id="solar-farm" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
    </div>

    <div class="asset" style="bottom:5%; left:5%; width:40px; height:60px; background:#2c3e50; border-radius:3px;">
        <div id="batt-fill" style="position:absolute; bottom:0; width:100%; background:#00ff41; height:50%;"></div>
    </div>
</div>

<div id="dashboard">
    <div style="font-size:9px; opacity:0.6; text-align:center">DRAG ME</div>
    <div style="margin:10px 0; border-bottom:1px solid #333">GRID STATUS</div>
    <div>EOLICO: <span id="db-wind">0</span> MW</div>
    <div>SOLARE: <span id="db-solar">0</span> MW</div>
    <div>TERMICO: <span id="db-therm">0</span> MW</div>
    <div>DOMANDA: <span id="db-load">0</span> MW</div>
    <div style="color:white; margin-top:5px">BATT: <span id="db-batt">50%</span></div>
</div>

<div style="position:fixed; bottom:20%; left:50%; transform:translateX(-50%); display:flex; gap:20px; background:white; padding:10px 30px; border-radius:50px; z-index:2000">
    <div>ðŸ•’ <span id="clock">12:00</span></div>
    <input type="range" id="therm-slider" value="0">
    <button id="batt-toggle">BATTERY OFF</button>
</div>

<script>
    // Inizializzazione Ambiente
    const winds = document.getElementById('wind-farm');
    for(let i=0; i<3; i++) {
        const w = document.createElement('div');
        w.className = 'asset'; w.style.left = (10+i*5)+'%'; w.style.top = (5+i*5)+'%';
        w.innerHTML = `<svg width="50" height="70" viewBox="0 0 100 100"><path d="M48 90 L52 90 L50 40 Z" fill="#eee"/><g style="transform-origin:50px 40px; animation:spin var(--wind-speed) linear infinite"><path d="M50 40 L50 10 L54 10 Z" fill="white"/><path d="M50 40 L80 55 L78 58 Z" fill="white"/><path d="M50 40 L20 55 L22 58 Z" fill="white"/></g></svg>`;
        winds.appendChild(w);
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    const houses = document.getElementById('residential');
    for(let i=0; i<10; i++) {
        const h = document.createElement('div');
        h.className = 'asset house'; h.style.left = (50+(i%3)*8)+'%'; h.style.top = (35+Math.floor(i/3)*10)+'%';
        h.innerHTML = `<div class="face roof"></div><div class="face side"><div class="win" style="top:5px;left:5px"></div></div><div class="face front"><div class="win" style="top:5px;left:5px"></div><div class="win" style="top:5px;left:18px"></div></div>`;
        houses.appendChild(h);
    }

    const solars = document.getElementById('solar-farm');
    for(let i=0; i<4; i++) {
        const s = document.createElement('div'); s.className = 'solar-block';
        solars.appendChild(s);
    }

    const lights = document.getElementById('lights-container');
    const lightPos = [{t:'58%', l:'43%'}, {t:'58%', l:'52%'}, {t:'65%', l:'48%'}];
    lightPos.forEach(p => {
        const l = document.createElement('div'); l.className = 'street-light'; l.style.top = p.t; l.style.left = p.l;
        l.innerHTML = `<div class="light-bulb"></div>`;
        lights.appendChild(l);
    });

    const carsContainer = document.getElementById('cars-container');
    const car = document.createElement('div'); car.className = 'car'; car.style.top = '61%'; 
    carsContainer.appendChild(car);

    // Drag Dashboard
    const db = document.getElementById("dashboard");
    let isDragging = false, offset = [0,0];
    db.onmousedown = (e) => { isDragging = true; offset = [db.offsetLeft - e.clientX, db.offsetTop - e.clientY]; };
    document.onmousemove = (e) => { if(isDragging) { db.style.left = (e.clientX + offset[0])+'px'; db.style.top = (e.clientY + offset[1])+'px'; }};
    document.onmouseup = () => isDragging = false;

    // Game Logic
    let time = 12, battery = 50, useBatt = false;
    document.getElementById('batt-toggle').onclick = function() { useBatt = !useBatt; this.style.background = useBatt ? '#00ff41':'#eee'; };

    function loop() {
        time = (time + 0.01) % 24;
        const isNight = time > 19 || time < 6;
        document.body.classList.toggle('night-mode', isNight);
        document.getElementById('clock').innerText = Math.floor(time).toString().padStart(2, '0') + ":00";
        
        // Animazione Auto
        car.style.left = ((time * 100) % 120) - 10 + "%";

        let windPower = 30 + Math.random() * 20;
        let solarPower = isNight ? 0 : 90 * Math.sin((time-6)*Math.PI/13);
        let thermal = parseInt(document.getElementById('therm-slider').value);
        let demand = isNight ? 40 : 130;
        let balance = (windPower + solarPower + thermal) - demand;

        if (balance > 0) battery = Math.min(100, battery + 0.04);
        else if (useBatt && battery > 0) { battery -= 0.08; balance += 35; }

        document.documentElement.style.setProperty('--wind-speed', (120-windPower)/20 + 's');
        document.getElementById('batt-fill').style.height = battery + "%";
        document.getElementById('db-wind').innerText = Math.floor(windPower);
        document.getElementById('db-solar').innerText = Math.floor(solarPower);
        document.getElementById('db-therm').innerText = thermal;
        document.getElementById('db-load').innerText = demand;
        document.getElementById('db-batt').innerText = Math.floor(battery) + "%";

        requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>
