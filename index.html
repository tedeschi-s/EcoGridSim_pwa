<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGrid City - Fixed & Dynamic</title>
    <style>
        :root { --wind-speed: 2s; --window-light: transparent; --lamp-glow: 0; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #2d3436; }

        #game-viewport {
            width: 100vw; height: 100vh;
            background: #55ad58;
            position: relative; transition: filter 2s;
            overflow: hidden;
        }

        .night-mode #game-viewport { background: #1a2a1a; filter: brightness(0.7); }
        .night-mode { --window-light: #fff176; --lamp-glow: 1; }

        /* MONTAGNA */
        .mountain {
            position: absolute; top: 2%; left: 2%; width: 200px; height: 120px;
            background: #7f8c8d; clip-path: polygon(0% 100%, 50% 0%, 100% 100%);
            z-index: 2; border-bottom: 10px solid #636e72;
        }

        /* STRADE */
        .road { position: absolute; background: #444; z-index: 1; }
        .road-v { width: 40px; height: 100%; left: 40%; }
        .road-h { width: 100%; height: 40px; top: 55%; }
        
        /* AUTO */
        .car {
            position: absolute; width: 15px; height: 8px; background: #e74c3c;
            border-radius: 2px; z-index: 5; top: 56%; left: -20px;
        }

        /* LAMPIONI */
        .light-pole { position: absolute; width: 3px; height: 25px; background: #2d3436; z-index: 6; }
        .bulb { 
            position: absolute; top: -5px; left: -3px; width: 8px; height: 8px; 
            background: #fff176; border-radius: 50%; opacity: var(--lamp-glow);
            box-shadow: 0 0 15px #fff176; transition: 1s;
        }

        /* ASSET */
        .asset { position: absolute; z-index: 10; }
        
        /* CASE ISOMETRICHE */
        .house { width: 40px; height: 45px; }
        .face { position: absolute; }
        .front { width: 25px; height: 25px; background: #ecf0f1; top: 15px; left: 0; }
        .side { width: 15px; height: 25px; background: #bdc3c7; top: 8px; left: 25px; transform: skewY(-20deg); }
        .roof { width: 25px; height: 18px; background: #c0392b; top: 0; left: 8px; transform: skewX(-45deg); }
        .win { width: 4px; height: 5px; background: var(--window-light); position: absolute; top: 5px; left: 5px; }

        /* PALE EOLICHE */
        .blades { transform-origin: center; animation: spin var(--wind-speed) linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* FUMO */
        .smoke { fill: white; opacity: 0; }
        .active-thermal .smoke { animation: puff 2s infinite linear; }
        @keyframes puff { 0% { transform: translateY(0) scale(1); opacity: 0.6; } 100% { transform: translateY(-30px) scale(2); opacity: 0; } }

        /* DASHBOARD */
        #dashboard {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.9); color: #00ff41; padding: 15px;
            border-radius: 10px; width: 200px; border: 1px solid #00ff41;
            z-index: 1000; cursor: move; font-family: monospace; font-size: 12px;
        }

        /* CONTROLLI */
        .ui-panel {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 25px; border-radius: 50px;
            display: flex; gap: 15px; align-items: center; z-index: 2000; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<div id="game-viewport">
    <div class="mountain"></div>
    <div class="road road-v"></div>
    <div class="road road-h"></div>
    <div id="car" class="car"></div>

    <div id="wind-farm"></div>
    <div id="residential-zone"></div>
    
    <svg id="thermal-plant" class="asset" style="top:10%; left:70%; width:100px" viewBox="0 0 100 80">
        <circle class="smoke" cx="30" cy="20" r="5"/>
        <rect x="20" y="40" width="50" height="30" fill="#333"/>
        <rect x="25" y="20" width="10" height="20" fill="#555"/>
    </svg>

    <div class="asset" style="bottom:10%; right:10%; border:1px dashed #2c3e50; padding:5px; display:grid; grid-template-columns:1fr 1fr; gap:5px;">
        <div style="width:40px; height:25px; background:#1a237e; transform:skewX(-10deg)"></div>
        <div style="width:40px; height:25px; background:#1a237e; transform:skewX(-10deg)"></div>
        <div style="width:40px; height:25px; background:#1a237e; transform:skewX(-10deg)"></div>
        <div style="width:40px; height:25px; background:#1a237e; transform:skewX(-10deg)"></div>
    </div>

    <div class="asset" style="bottom:5%; left:5%; width:40px; height:60px; background:#2c3e50; border-radius:3px;">
        <div id="batt-fill" style="position:absolute; bottom:0; width:100%; background:#00ff41; height:50%;"></div>
    </div>
</div>

<div id="dashboard">
    <div style="text-align:center; font-size:9px; border-bottom:1px solid #333; margin-bottom:5px">DRAG PANEL</div>
    <div>WIND: <span id="db-wind">0</span> MW</div>
    <div>SUN: <span id="db-solar">0</span> MW</div>
    <div>PLANT: <span id="db-thermal">0</span> MW</div>
    <div>LOAD: <span id="db-load">0</span> MW</div>
    <div style="border-top:1px solid #333; margin-top:5px">BATT: <span id="db-batt">50%</span></div>
</div>

<div class="ui-panel">
    <div>ðŸ•’ <span id="clock">12:00</span></div>
    <input type="range" id="thermal-slider" value="0">
    <button id="batt-btn" style="cursor:pointer; border-radius:15px; border:1px solid #ccc; padding:5px 10px;">BATT OFF</button>
</div>

<script>
    // Genera Mulini sulla Montagna
    const winds = document.getElementById('wind-farm');
    for(let i=0; i<3; i++) {
        const w = document.createElement('div');
        w.className = 'asset'; w.style.left = (5 + i*4) + '%'; w.style.top = (2 + i*4) + '%';
        w.innerHTML = `<svg width="40" height="60" viewBox="0 0 100 100"><path d="M48 90 L52 90 L50 40 Z" fill="#ddd"/><g class="blades" style="transform-box:fill-box; transform-origin:center;"><path d="M50 40 L50 10 L54 10 Z" fill="white"/><path d="M50 40 L80 55 L78 58 Z" fill="white"/><path d="M50 40 L20 55 L22 58 Z" fill="white"/></g></svg>`;
        winds.appendChild(w);
    }

    // Genera Case
    const res = document.getElementById('residential-zone');
    for(let i=0; i<12; i++) {
        const h = document.createElement('div');
        h.className = 'asset house'; h.style.left = (45 + (i%4)*6) + '%'; h.style.top = (35 + Math.floor(i/4)*8) + '%';
        h.innerHTML = `<div class="face roof"></div><div class="face side"><div class="win"></div></div><div class="face front"><div class="win"></div></div>`;
        res.appendChild(h);
    }

    // Drag Dashboard
    const db = document.getElementById("dashboard");
    let isDragging = false, offset = [0,0];
    db.onmousedown = (e) => { isDragging = true; offset = [db.offsetLeft - e.clientX, db.offsetTop - e.clientY]; };
    document.onmousemove = (e) => { if(isDragging) { db.style.left = (e.clientX + offset[0]) + 'px'; db.style.top = (e.clientY + offset[1]) + 'px'; } };
    document.onmouseup = () => isDragging = false;

    // Game Logic
    let time = 12, battery = 50, useBatt = false;
    document.getElementById('batt-btn').onclick = function() { useBatt = !useBatt; this.innerText = useBatt ? "BATT ON" : "BATT OFF"; this.style.background = useBatt ? "#00ff41" : "#eee"; };

    function loop() {
        time = (time + 0.01) % 24;
        const isNight = time > 19 || time < 6;
        document.body.classList.toggle('night-mode', isNight);
        document.getElementById('clock').innerText = Math.floor(time).toString().padStart(2, '0') + ":00";

        // Auto
        const car = document.getElementById('car');
        car.style.left = ((time * 80) % 120) - 10 + "%";

        // Potenza
        let wind = 30 + Math.random() * 20;
        let sun = isNight ? 0 : 80 * Math.sin((time-6)*Math.PI/13);
        let thermal = parseInt(document.getElementById('thermal-slider').value);
        let demand = isNight ? 40 : 130;
        let balance = (wind + sun + thermal) - demand;

        if(balance > 0) battery = Math.min(100, battery + 0.05);
        else if(useBatt && battery > 0) { battery -= 0.1; balance += 40; }

        // Update UI
        document.getElementById('db-wind').innerText = Math.floor(wind);
        document.getElementById('db-solar').innerText = Math.floor(sun);
        document.getElementById('db-thermal').innerText = thermal;
        document.getElementById('db-load').innerText = demand;
        document.getElementById('db-batt').innerText = Math.floor(battery) + "%";
        document.getElementById('batt-fill').style.height = battery + "%";
        document.documentElement.style.setProperty('--wind-speed', (120-wind)/20 + 's');
        document.getElementById('thermal-plant').classList.toggle('active-thermal', thermal > 5);

        requestAnimationFrame(loop);
    }
    loop();
</script>
</body>
</html>
