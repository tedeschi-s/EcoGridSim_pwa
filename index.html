<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoGrid - Strategic Balance</title>
    <style>
        /* (Stili precedenti mantenuti e ottimizzati) */
        :root { --wind-speed: 2s; --window-light: transparent; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #2d3436; }
        #top-bar { position: absolute; top: 0; left: 0; width: 100%; height: 60px; background: #1e272e; color: white; display: flex; align-items: center; justify-content: space-around; z-index: 3000; }
        .stat { font-family: monospace; font-size: 15px; font-weight: bold; }
        #co2-fill { height: 100%; width: 0%; background: #ff7675; transition: 0.5s; }
        #side-panel { position: absolute; left: 10px; top: 70px; width: 200px; z-index: 2500; display: flex; flex-direction: column; gap: 10px; }
        .ui-box { background: rgba(255,255,255,0.95); padding: 12px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .store-item { background: #f1f2f6; border: 1px solid #ccc; border-radius: 8px; padding: 8px; margin-bottom: 5px; cursor: pointer; font-size: 11px; }
        .store-item:hover { border-color: #2ecc71; }
        #game-viewport { width: 100vw; height: 100vh; background: #55ad58; position: relative; overflow: hidden; }
        .placed-asset { position: absolute; z-index: 100; cursor: grab; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; color: white; flex-direction: column; align-items: center; justify-content: center; text-align: center; background: rgba(0,0,0,0.9); }
    </style>
</head>
<body>

<div id="top-bar">
    <div class="stat">üí∞ $<span id="budget">3000</span></div>
    <div class="stat">üè† Abitanti: <span id="pop">0</span></div>
    <div class="stat">‚òÅÔ∏è CO2: <div style="width:100px; height:10px; background:#444; display:inline-block;"><div id="co2-fill"></div></div></div>
    <div class="stat">üïí <span id="clock">12:00</span></div>
</div>

<div id="side-panel">
    <div class="ui-box">
        <h4 style="margin:0 0 10px 0;">üèóÔ∏è COSTRUISCI</h4>
        <div class="store-item" onclick="spawnAsset('house')">üè† <b>Casa</b> ($800)<br>Genera Tasse ($$) | Chiede 20MW</div>
        <div class="store-item" onclick="spawnAsset('wind')">üåÄ <b>Eolico</b> ($1500)<br>Mantenimento: -$10/h</div>
        <div class="store-item" onclick="spawnAsset('solar')">‚òÄÔ∏è <b>Solare</b> ($1000)<br>Mantenimento: -$5/h</div>
        <div class="store-item" onclick="spawnAsset('plant')">üè≠ <b>Centrale</b> ($2500)<br>Mantenimento: -$50/h</div>
        <div class="store-item" onclick="spawnAsset('tree')">üå≥ <b>Albero</b> ($150)</div>
    </div>
    <div class="ui-box" style="font-size:10px;">
        <b>üí° STRATEGIA:</b> Solo le case portano soldi. Se metti solo mulini, finirai il budget per la manutenzione!
    </div>
</div>

<div id="game-viewport"></div>

<div id="game-over" class="overlay">
    <h1 id="go-title">GAME OVER</h1>
    <p id="go-msg"></p>
    <button onclick="location.reload()" style="padding:10px 20px; cursor:pointer;">RIPROVA</button>
</div>

<script>
    let budget = 3000;
    let co2Level = 0;
    let time = 12;
    let assets = [];
    let blackoutCounter = 0;

    const stats = {
        house: { cost: 800, prod: -20, co2: 2, tax: 40 }, // Tax √® il guadagno orario
        wind: { cost: 1500, prod: 50, co2: 0, maint: 10 },
        solar: { cost: 1000, prod: 30, co2: 0, maint: 5 },
        plant: { cost: 2500, prod: 150, co2: 15, maint: 50 },
        tree: { cost: 150, prod: 0, co2: -8, maint: 0 }
    };

    const templates = {
        house: `<div style="width:30px;height:30px;background:#fff;border:1px solid #ccc;position:relative"><div style="background:red;width:100%;height:10px;position:absolute;top:-10px"></div></div>`,
        wind: `<div style="width:2px;height:40px;background:#eee;margin-left:14px;position:relative"><div style="width:30px;height:30px;border-radius:50%;border:2px dashed #fff;position:absolute;top:-15px;left:-15px;animation:spin 2s linear infinite"></div></div>`,
        solar: `<div style="width:30px;height:20px;background:#1a237e;border:1px solid #fff"></div>`,
        plant: `<div style="width:40px;height:30px;background:#333;border-top:5px solid #555"></div>`,
        tree: `<div style="width:15px;height:15px;background:green;border-radius:50%"></div>`
    };

    function spawnAsset(type) {
        if (budget < stats[type].cost) return alert("Soldi finiti!");
        budget -= stats[type].cost;
        const div = document.createElement('div');
        div.className = 'placed-asset';
        div.innerHTML = templates[type];
        div.style.left = '300px'; div.style.top = '200px';
        document.getElementById('game-viewport').appendChild(div);
        const obj = { el: div, type: type, x: 300, y: 200 };
        assets.push(obj);
        makeDraggable(div, obj);
    }

    function makeDraggable(el, obj) {
        let move = false;
        el.onmousedown = () => move = true;
        document.onmousemove = (e) => { if(move){ obj.x=e.clientX-15; obj.y=e.clientY-15; el.style.left=obj.x+'px'; el.style.top=obj.y+'px'; } };
        document.onmouseup = () => move = false;
    }

    function loop() {
        time = (time + 0.02) % 24;
        const isNight = time > 19 || time < 6;
        document.getElementById('clock').innerText = Math.floor(time).toString().padStart(2, '0') + ":00";

        let prod = 0, load = 0, co2Delta = 0, hourlyIncome = 0, hourlyMaint = 0, pop = 0;

        assets.forEach(a => {
            const s = stats[a.type];
            if (s.prod > 0) {
                if (a.type === 'wind') prod += s.prod * (Math.random() > 0.2 ? 1 : 0.1);
                else if (a.type === 'solar') prod += isNight ? 0 : s.prod;
                else prod += s.prod;
                hourlyMaint += s.maint;
            } else if (a.type === 'house') {
                load += Math.abs(s.prod);
                hourlyIncome += s.tax;
                pop += 4;
            }
            co2Delta += s.co2;
        });

        // ECONOMIA: Tasse - Manutenzione
        // Se c'√® blackout, i cittadini non pagano le tasse!
        let currentIncome = (prod >= load && load > 0) ? hourlyIncome : 0;
        budget += (currentIncome - hourlyMaint) / 50; 

        co2Level = Math.max(0, Math.min(100, co2Level + (co2Delta * 0.005)));
        
        // UI
        document.getElementById('budget').innerText = Math.floor(budget);
        document.getElementById('pop').innerText = pop;
        document.getElementById('co2-fill').style.width = co2Level + "%";

        // SCONFITTA
        if (budget <= 0) endGame("FALLIMENTO ECONOMICO", "Hai speso tutto per le infrastrutture senza avere abbastanza cittadini!");
        if (co2Level >= 100) endGame("ECCESSO CO2", "La citt√† √® invivibile.");

        requestAnimationFrame(loop);
    }

    function endGame(title, msg) {
        document.getElementById('go-title').innerText = title;
        document.getElementById('go-msg').innerText = msg;
        document.getElementById('game-over').style.display = 'flex';
    }

    loop();
</script>
</body>
</html>
